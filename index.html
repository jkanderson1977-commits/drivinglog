<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="Drive Log">
    <link rel="apple-touch-icon" href="icon-192.png">
    <link rel="manifest" href="manifest.json">
    <title>PA Driving Log</title>
    <style>
        * {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 0;
            background: #f5f5f7;
            color: #1d1d1f;
            min-height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%);
            color: white;
            padding: 20px;
            padding-top: max(20px, env(safe-area-inset-top));
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .header h1 {
            margin: 0;
            font-size: 1.4em;
            font-weight: 600;
        }
        
        .header p {
            margin: 5px 0 0;
            font-size: 0.85em;
            opacity: 0.9;
        }
        
        .progress-section {
            background: white;
            margin: 15px;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .progress-title {
            font-weight: 600;
            margin-bottom: 12px;
            color: #1a5276;
        }
        
        .progress-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
        }
        
        .progress-item {
            text-align: center;
            padding: 10px;
            background: #f5f5f7;
            border-radius: 8px;
        }
        
        .progress-item.complete {
            background: #d4edda;
        }
        
        .progress-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #1a5276;
        }
        
        .progress-item.complete .progress-value {
            color: #28a745;
        }
        
        .progress-label {
            font-size: 0.75em;
            color: #666;
            margin-top: 2px;
        }
        
        .progress-bar {
            height: 6px;
            background: #e0e0e0;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #1a5276, #2980b9);
            border-radius: 3px;
            transition: width 0.3s ease;
        }
        
        .progress-item.complete .progress-fill {
            background: #28a745;
        }
        
        .tabs {
            display: flex;
            background: white;
            margin: 0 15px;
            border-radius: 12px;
            padding: 5px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            text-align: center;
            border: none;
            background: none;
            font-size: 0.95em;
            font-weight: 500;
            color: #666;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .tab.active {
            background: #1a5276;
            color: white;
        }
        
        .tab-content {
            display: none;
            padding: 15px;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 6px;
            color: #333;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            -webkit-appearance: none;
        }
        
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none;
            border-color: #2980b9;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .checkbox-group {
            display: flex;
            gap: 20px;
            margin-top: 5px;
        }
        
        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .checkbox-item input[type="checkbox"] {
            width: 22px;
            height: 22px;
            accent-color: #1a5276;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #1a5276 0%, #2980b9 100%);
            color: white;
        }
        
        .btn-primary:active {
            transform: scale(0.98);
        }
        
        .btn-secondary {
            background: #e0e0e0;
            color: #333;
            margin-top: 10px;
        }
        
        .btn-danger {
            background: #dc3545;
            color: white;
            padding: 8px 12px;
            font-size: 0.85em;
        }
        
        .log-entry {
            background: white;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }
        
        .log-entry-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        
        .log-entry-date {
            font-weight: 600;
            color: #1a5276;
        }
        
        .log-entry-hours {
            background: #1a5276;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.85em;
            font-weight: 600;
        }
        
        .log-entry-details {
            font-size: 0.9em;
            color: #666;
        }
        
        .log-entry-tags {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }
        
        .tag {
            font-size: 0.75em;
            padding: 3px 8px;
            border-radius: 10px;
            font-weight: 500;
        }
        
        .tag-night {
            background: #fff3cd;
            color: #856404;
        }
        
        .tag-weather {
            background: #d4edda;
            color: #155724;
        }
        
        .log-entry-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid #eee;
        }
        
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }
        
        .empty-state-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }
        
        .export-section {
            margin-top: 20px;
        }
        
        .info-box {
            background: #e8f4fd;
            border-left: 4px solid #2980b9;
            padding: 12px;
            border-radius: 0 8px 8px 0;
            margin-bottom: 15px;
            font-size: 0.9em;
        }
        
        .driver-info-display {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        
        .driver-info-display p {
            margin: 5px 0;
            font-size: 0.9em;
        }
        
        .driver-info-display strong {
            color: #1a5276;
        }
        
        .toast {
            position: fixed;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 12px 24px;
            border-radius: 25px;
            font-size: 0.9em;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .toast.show {
            opacity: 1;
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>üöó PA Driving Log</h1>
        <p>65 hrs total ‚Ä¢ 10 hrs night ‚Ä¢ 5 hrs bad weather</p>
    </div>
    
    <div class="progress-section">
        <div class="progress-title">Progress to Road Test</div>
        <div class="progress-grid">
            <div class="progress-item" id="progress-total">
                <div class="progress-value"><span id="total-hours">0</span>/65</div>
                <div class="progress-label">Total Hours</div>
                <div class="progress-bar"><div class="progress-fill" id="fill-total" style="width: 0%"></div></div>
            </div>
            <div class="progress-item" id="progress-night">
                <div class="progress-value"><span id="night-hours">0</span>/10</div>
                <div class="progress-label">Night Hours</div>
                <div class="progress-bar"><div class="progress-fill" id="fill-night" style="width: 0%"></div></div>
            </div>
            <div class="progress-item" id="progress-weather">
                <div class="progress-value"><span id="weather-hours">0</span>/5</div>
                <div class="progress-label">Bad Weather</div>
                <div class="progress-bar"><div class="progress-fill" id="fill-weather" style="width: 0%"></div></div>
            </div>
        </div>
    </div>
    
    <div class="tabs">
        <button class="tab active" onclick="showTab('log')">Add Entry</button>
        <button class="tab" onclick="showTab('history')">History</button>
        <button class="tab" onclick="showTab('settings')">Settings</button>
    </div>
    
    <div id="tab-log" class="tab-content active">
        <div class="card">
            <div class="form-group">
                <label>Date</label>
                <input type="date" id="entry-date">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Start Time</label>
                    <input type="time" id="entry-start">
                </div>
                <div class="form-group">
                    <label>End Time</label>
                    <input type="time" id="entry-end">
                </div>
            </div>
            <div class="form-group">
                <label>Hours Driven</label>
                <input type="number" id="entry-hours" step="0.25" min="0" max="8" placeholder="Auto-calculated or enter manually">
            </div>
            <div class="form-group">
                <label>Route / Locations</label>
                <input type="text" id="entry-route" placeholder="e.g., Home to school and back">
            </div>
            <div class="form-group">
                <label>Skills Practiced</label>
                <textarea id="entry-skills" rows="2" placeholder="e.g., Parking, highway merging, left turns"></textarea>
            </div>
            <div class="form-group">
                <label>Conditions</label>
                <div class="checkbox-group">
                    <label class="checkbox-item">
                        <input type="checkbox" id="entry-night">
                        <span>üåô Night Driving</span>
                    </label>
                    <label class="checkbox-item">
                        <input type="checkbox" id="entry-weather">
                        <span>üåßÔ∏è Bad Weather</span>
                    </label>
                </div>
            </div>
            <div class="form-group">
                <label>Supervising Driver</label>
                <input type="text" id="entry-supervisor" placeholder="Name of licensed driver">
            </div>
            <button class="btn btn-primary" onclick="saveEntry()">Save Entry</button>
        </div>
    </div>
    
    <div id="tab-history" class="tab-content">
        <div id="history-list">
            <div class="empty-state">
                <div class="empty-state-icon">üìã</div>
                <p>No driving sessions logged yet.<br>Add your first entry to get started!</p>
            </div>
        </div>
        <div class="export-section">
            <button class="btn btn-secondary" onclick="exportCSV()">üì• Export to CSV</button>
        </div>
    </div>
    
    <div id="tab-settings" class="tab-content">
        <div class="card">
            <h3 style="margin-top: 0; color: #1a5276;">Driver Information</h3>
            <div class="form-group">
                <label>Driver Name</label>
                <input type="text" id="driver-name" placeholder="Enter driver's name">
            </div>
            <div class="form-group">
                <label>Date of Birth</label>
                <input type="date" id="driver-dob">
            </div>
            <div class="form-group">
                <label>Permit Issue Date</label>
                <input type="date" id="permit-issue">
            </div>
            <div class="form-group">
                <label>Permit Expiration Date</label>
                <input type="date" id="permit-expire">
            </div>
            <button class="btn btn-primary" onclick="saveDriverInfo()">Save Driver Info</button>
        </div>
        
        <div class="card">
            <h3 style="margin-top: 0; color: #1a5276;">Data Management</h3>
            <div class="info-box">
                Your data is stored locally on this device. Export regularly to keep a backup.
            </div>
            <button class="btn btn-secondary" onclick="exportCSV()">üì• Export All Data to CSV</button>
            <button class="btn btn-danger" style="width: 100%; margin-top: 10px;" onclick="confirmClearData()">üóëÔ∏è Clear All Data</button>
        </div>
        
        <div class="card">
            <h3 style="margin-top: 0; color: #1a5276;">PA Requirements Reminder</h3>
            <ul style="font-size: 0.9em; color: #666; padding-left: 20px;">
                <li>65 total supervised driving hours</li>
                <li>At least 10 hours at night</li>
                <li>At least 5 hours in bad weather</li>
                <li>Hold permit for 6 months minimum</li>
                <li>Supervisor must be 21+ (or parent/guardian 18+)</li>
                <li>No driving between 11 PM - 5 AM</li>
            </ul>
        </div>
    </div>
    
    <div class="toast" id="toast"></div>
    
    <script>
        // Initialize
        let entries = JSON.parse(localStorage.getItem('drivingLog') || '[]');
        let driverInfo = JSON.parse(localStorage.getItem('driverInfo') || '{}');
        
        // Set default date to today
        document.getElementById('entry-date').valueAsDate = new Date();
        
        // Load driver info into form
        if (driverInfo.name) document.getElementById('driver-name').value = driverInfo.name;
        if (driverInfo.dob) document.getElementById('driver-dob').value = driverInfo.dob;
        if (driverInfo.permitIssue) document.getElementById('permit-issue').value = driverInfo.permitIssue;
        if (driverInfo.permitExpire) document.getElementById('permit-expire').value = driverInfo.permitExpire;
        if (driverInfo.supervisor) document.getElementById('entry-supervisor').value = driverInfo.supervisor;
        
        // Auto-calculate hours when times change
        document.getElementById('entry-start').addEventListener('change', calculateHours);
        document.getElementById('entry-end').addEventListener('change', calculateHours);
        
        function calculateHours() {
            const start = document.getElementById('entry-start').value;
            const end = document.getElementById('entry-end').value;
            if (start && end) {
                const startMin = timeToMinutes(start);
                const endMin = timeToMinutes(end);
                let diff = endMin - startMin;
                if (diff < 0) diff += 24 * 60; // Handle overnight
                const hours = Math.round(diff / 15) * 0.25; // Round to nearest 0.25
                document.getElementById('entry-hours').value = hours;
            }
        }
        
        function timeToMinutes(time) {
            const [h, m] = time.split(':').map(Number);
            return h * 60 + m;
        }
        
        function showTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelector(`.tab:nth-child(${tab === 'log' ? 1 : tab === 'history' ? 2 : 3})`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            if (tab === 'history') renderHistory();
        }
        
        function saveEntry() {
            const entry = {
                id: Date.now(),
                date: document.getElementById('entry-date').value,
                startTime: document.getElementById('entry-start').value,
                endTime: document.getElementById('entry-end').value,
                hours: parseFloat(document.getElementById('entry-hours').value) || 0,
                route: document.getElementById('entry-route').value,
                skills: document.getElementById('entry-skills').value,
                night: document.getElementById('entry-night').checked,
                weather: document.getElementById('entry-weather').checked,
                supervisor: document.getElementById('entry-supervisor').value
            };
            
            if (!entry.date || !entry.hours) {
                showToast('Please enter date and hours');
                return;
            }
            
            entries.push(entry);
            localStorage.setItem('drivingLog', JSON.stringify(entries));
            
            // Save supervisor for next time
            if (entry.supervisor) {
                driverInfo.supervisor = entry.supervisor;
                localStorage.setItem('driverInfo', JSON.stringify(driverInfo));
            }
            
            // Reset form
            document.getElementById('entry-date').valueAsDate = new Date();
            document.getElementById('entry-start').value = '';
            document.getElementById('entry-end').value = '';
            document.getElementById('entry-hours').value = '';
            document.getElementById('entry-route').value = '';
            document.getElementById('entry-skills').value = '';
            document.getElementById('entry-night').checked = false;
            document.getElementById('entry-weather').checked = false;
            
            updateProgress();
            showToast('Entry saved!');
        }
        
        function updateProgress() {
            let total = 0, night = 0, weather = 0;
            entries.forEach(e => {
                total += e.hours;
                if (e.night) night += e.hours;
                if (e.weather) weather += e.hours;
            });
            
            document.getElementById('total-hours').textContent = total.toFixed(1);
            document.getElementById('night-hours').textContent = night.toFixed(1);
            document.getElementById('weather-hours').textContent = weather.toFixed(1);
            
            document.getElementById('fill-total').style.width = Math.min(100, (total / 65) * 100) + '%';
            document.getElementById('fill-night').style.width = Math.min(100, (night / 10) * 100) + '%';
            document.getElementById('fill-weather').style.width = Math.min(100, (weather / 5) * 100) + '%';
            
            document.getElementById('progress-total').classList.toggle('complete', total >= 65);
            document.getElementById('progress-night').classList.toggle('complete', night >= 10);
            document.getElementById('progress-weather').classList.toggle('complete', weather >= 5);
        }
        
        function renderHistory() {
            const list = document.getElementById('history-list');
            if (entries.length === 0) {
                list.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">üìã</div>
                        <p>No driving sessions logged yet.<br>Add your first entry to get started!</p>
                    </div>`;
                return;
            }
            
            // Sort by date descending
            const sorted = [...entries].sort((a, b) => new Date(b.date) - new Date(a.date));
            
            list.innerHTML = sorted.map(e => `
                <div class="log-entry">
                    <div class="log-entry-header">
                        <span class="log-entry-date">${formatDate(e.date)}</span>
                        <span class="log-entry-hours">${e.hours} hrs</span>
                    </div>
                    <div class="log-entry-details">
                        ${e.startTime && e.endTime ? `${formatTime(e.startTime)} - ${formatTime(e.endTime)}<br>` : ''}
                        ${e.route ? `üìç ${e.route}<br>` : ''}
                        ${e.skills ? `‚úì ${e.skills}<br>` : ''}
                        ${e.supervisor ? `üë§ ${e.supervisor}` : ''}
                    </div>
                    ${e.night || e.weather ? `
                        <div class="log-entry-tags">
                            ${e.night ? '<span class="tag tag-night">üåô Night</span>' : ''}
                            ${e.weather ? '<span class="tag tag-weather">üåßÔ∏è Weather</span>' : ''}
                        </div>
                    ` : ''}
                    <div class="log-entry-actions">
                        <button class="btn btn-danger" onclick="deleteEntry(${e.id})">Delete</button>
                    </div>
                </div>
            `).join('');
        }
        
        function formatDate(dateStr) {
            const d = new Date(dateStr + 'T00:00:00');
            return d.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
        }
        
        function formatTime(timeStr) {
            const [h, m] = timeStr.split(':');
            const hour = parseInt(h);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${m} ${ampm}`;
        }
        
        function deleteEntry(id) {
            if (confirm('Delete this entry?')) {
                entries = entries.filter(e => e.id !== id);
                localStorage.setItem('drivingLog', JSON.stringify(entries));
                updateProgress();
                renderHistory();
                showToast('Entry deleted');
            }
        }
        
        function saveDriverInfo() {
            driverInfo = {
                ...driverInfo,
                name: document.getElementById('driver-name').value,
                dob: document.getElementById('driver-dob').value,
                permitIssue: document.getElementById('permit-issue').value,
                permitExpire: document.getElementById('permit-expire').value
            };
            localStorage.setItem('driverInfo', JSON.stringify(driverInfo));
            showToast('Driver info saved!');
        }
        
        function exportCSV() {
            if (entries.length === 0) {
                showToast('No entries to export');
                return;
            }
            
            const headers = ['Date', 'Start Time', 'End Time', 'Hours', 'Route', 'Skills Practiced', 'Night Driving', 'Bad Weather', 'Supervisor'];
            const rows = entries.map(e => [
                e.date,
                e.startTime || '',
                e.endTime || '',
                e.hours,
                `"${(e.route || '').replace(/"/g, '""')}"`,
                `"${(e.skills || '').replace(/"/g, '""')}"`,
                e.night ? 'Yes' : 'No',
                e.weather ? 'Yes' : 'No',
                `"${(e.supervisor || '').replace(/"/g, '""')}"`
            ]);
            
            // Add summary
            let total = 0, night = 0, weather = 0;
            entries.forEach(e => {
                total += e.hours;
                if (e.night) night += e.hours;
                if (e.weather) weather += e.hours;
            });
            
            let csv = `PA Driving Log - ${driverInfo.name || 'Student Driver'}\n`;
            csv += `Permit Issue Date: ${driverInfo.permitIssue || 'N/A'}\n`;
            csv += `Total Hours: ${total.toFixed(1)} / 65 required\n`;
            csv += `Night Hours: ${night.toFixed(1)} / 10 required\n`;
            csv += `Bad Weather Hours: ${weather.toFixed(1)} / 5 required\n\n`;
            csv += headers.join(',') + '\n';
            csv += rows.map(r => r.join(',')).join('\n');
            
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `driving-log-${new Date().toISOString().slice(0,10)}.csv`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('CSV exported!');
        }
        
        function confirmClearData() {
            if (confirm('Are you sure you want to delete ALL driving log data? This cannot be undone.')) {
                if (confirm('Really delete everything?')) {
                    entries = [];
                    localStorage.removeItem('drivingLog');
                    updateProgress();
                    showToast('All data cleared');
                }
            }
        }
        
        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2000);
        }
        
        // Initial render
        updateProgress();
        
        // Register service worker for offline support
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('sw.js').catch(() => {});
        }
    </script>
</body>
</html>
